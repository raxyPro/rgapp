{% extends "app_shell.html" %}
{% block content %}

<style>
  :root {
    --p-blue: #5a7fbe;
    --p-blue-soft: #e7f1ff;
    --p-green: #8bb963;
    --p-green-soft: #eef6e9;
    --p-orange: #d89a5b;
    --p-orange-soft: #f9efe4;
    --p-yellow: #f0c060;
    --p-yellow-soft: #fbf4e2;
    --p-purple: #b69ad2;
    --p-purple-soft: #efe9f8;
    --p-border: #d9dee7;
    --p-text: #24324a;
    --p-muted: #6b7280;
  }

  .profiles-wrap {
    display: grid;
    gap: 14px;
  }

  .profile-card {
    background: #fff;
    border: 1px solid var(--p-border);
    border-radius: 10px;
    box-shadow: 0 6px 16px rgba(36, 50, 74, 0.06);
    overflow: hidden;
  }

  .section-head {
    padding: 10px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    font-weight: 700;
    color: var(--p-text);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
  }

  .section-title i {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #fff;
  }

  .section-body {
    padding: 14px;
  }

  .vcard-panel {
    display: grid;
    grid-template-columns: 84px 1fr auto;
    gap: 14px;
    background: var(--p-blue-soft);
    border-radius: 10px;
    padding: 14px;
    align-items: center;
  }

  .vcard-avatar {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: #d8e6ff;
    display: grid;
    place-items: center;
    color: #3b5ea0;
    font-size: 30px;
  }

  .vcard-name {
    font-weight: 700;
    font-size: 16px;
  }

  .vcard-sub {
    color: var(--p-muted);
    font-size: 13px;
    margin-top: 2px;
  }

  .vcard-meta {
    display: grid;
    gap: 4px;
    font-size: 12.5px;
    color: #475569;
  }

  .vcard-actions {
    display: grid;
    gap: 8px;
  }

  .vcard-actions .btn {
    font-size: 12px;
    font-weight: 700;
    border-radius: 8px;
    padding: 6px 12px;
  }

  .vcard-actions .btn-primary {
    background: #4f7dc6;
    border-color: #4f7dc6;
  }

  .vcard-full {
    margin-top: 12px;
    border: 1px solid #dfe6f2;
    border-radius: 10px;
    background: #fff;
    padding: 14px;
  }

  .vcard-full-grid {
    display: grid;
    gap: 12px;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .vcard-full-section {
    border: 1px solid #eef1f6;
    border-radius: 10px;
    padding: 12px;
    background: #f9fbff;
  }

  .vcard-full-title {
    font-size: 12px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: #5a6d8a;
    margin-bottom: 6px;
  }

  .vcard-full-list {
    display: grid;
    gap: 6px;
    font-size: 13px;
  }

  .vcard-item {
    background: #fff;
    border: 1px solid #e6ecf5;
    border-radius: 10px;
    padding: 10px 12px;
  }

  .vcard-item-title {
    font-weight: 700;
    font-size: 13px;
  }

  .vcard-item-sub {
    color: #64748b;
    font-size: 12px;
  }

  .cv-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    padding: 10px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: #faf7ef;
    align-items: center;
    margin-bottom: 8px;
  }

  .cv-row:last-child {
    margin-bottom: 0;
  }

  .cv-title {
    font-weight: 700;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .cv-status {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 6px;
  }

  .pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 700;
    color: #fff;
  }

  .pill.green { background: #7eb156; }
  .pill.orange { background: #e2a157; }

  .cv-actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .icon-btn {
    width: 34px;
    height: 30px;
    border: 1px solid #d5dbe6;
    border-radius: 6px;
    background: #fff;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #3f506e;
  }

  .icon-btn.danger { color: #c2410c; border-color: #f1c8b3; }

  .section-add {
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 700;
  }

  .send-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #efd9c6;
    background: #fff8ef;
    margin-bottom: 8px;
  }

  .shared-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    border: 1px solid #d9d2e8;
    border-radius: 8px;
    background: #f6f3fb;
  }

  .shared-actions {
    display: flex;
    gap: 8px;
  }

  .share-details {
    margin-top: 8px;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px dashed #d6deea;
    background: #f8fafc;
    font-size: 12.5px;
    color: #445268;
  }

  @media (max-width: 900px) {
    .vcard-panel { grid-template-columns: 1fr; }
    .vcard-actions { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .vcard-full-grid { grid-template-columns: 1fr; }
  }
</style>

<div class="profiles-wrap">
  <section class="profile-card">
    <div class="section-head" style="background:#f6f8fc;">
      <div class="section-title">
        <i class="bi bi-person-badge" style="background: var(--p-blue);"></i>
        My vCard
      </div>
    </div>
    <div class="section-body">
      <div class="vcard-panel">
        <div class="vcard-avatar"><i class="bi bi-person"></i></div>
        <div>
          <div class="vcard-name">{{ vcard.name or "Your name" }}</div>
          <div class="vcard-sub">{{ vcard.tagline or "Marketing Specialist" }}</div>
          <div class="vcard-meta">
            <div><i class="bi bi-envelope"></i> {{ vcard.email or "email@example.com" }}</div>
            <div><i class="bi bi-geo-alt"></i> {{ vcard.location or "New York, NY" }}</div>
          </div>
        </div>
        <div class="vcard-actions">
          <button class="btn btn-primary" type="button" onclick="toggleVcardFull(this)">
            <i class="bi bi-heart-fill"></i> <span>View vCard</span>
          </button>
          <a class="btn btn-primary" href="{{ url_for('profiles.download_vcard_json') }}"><i class="bi bi-download"></i> Download JSON</a>
          <a class="btn btn-primary" href="{{ url_for('profiles.edit_vcard') }}"><i class="bi bi-pencil"></i> Edit</a>
        </div>
      </div>

      <div id="vcardFull" style="display:none;">
        <div class="vcard-full">
          <div class="vcard-full-grid">
            <div class="vcard-full-section">
              <div class="vcard-full-title">Contact</div>
              <div class="vcard-full-list">
                <div><strong>Email:</strong> {{ vcard.email or "Not set" }}</div>
                <div><strong>Phone:</strong> {{ vcard.phone or "Not set" }}</div>
                <div><strong>LinkedIn:</strong>
                  {% if vcard.linkedin_url %}
                    <a href="{{ vcard.linkedin_url }}" target="_blank">{{ vcard.linkedin_url }}</a>
                  {% else %}Not set{% endif %}
                </div>
                <div><strong>Tagline:</strong> {{ vcard.tagline or "Not set" }}</div>
                <div><strong>Location:</strong> {{ vcard.location or "Not set" }}</div>
                <div><strong>City:</strong> {{ vcard.city or "Not set" }}</div>
              </div>
            </div>
            <div class="vcard-full-section">
              <div class="vcard-full-title">Availability</div>
              <div class="vcard-full-list">
                <div><strong>Work mode:</strong>
                  {% if vcard.work_mode == 'wfo' %}Work from office{% elif vcard.work_mode == 'hybrid' %}Hybrid{% elif vcard.work_mode == 'remote' %}Remote{% else %}Not set{% endif %}
                </div>
                <div><strong>Available from:</strong> {{ vcard.available_from or "Not set" }}</div>
                <div><strong>Hours per day:</strong> {{ vcard.hours_per_day or "Not set" }}</div>
              </div>
            </div>
            <div class="vcard-full-section">
              <div class="vcard-full-title">Preferences</div>
              <div class="vcard-full-list">
                <div><strong>Preferred location:</strong> {{ vcard.job_pref_loc or "Not set" }}</div>
                <div><strong>Preferred work mode:</strong>
                  {% if vcard.job_pref_mode == 'wfo' %}Work from office{% elif vcard.job_pref_mode == 'hybrid' %}Hybrid{% elif vcard.job_pref_mode == 'remote' %}Remote{% else %}Not set{% endif %}
                </div>
                <div><strong>Preferred city:</strong> {{ vcard.job_pref_city or "Not set" }}</div>
                <div><strong>Preferred hours per day:</strong> {{ vcard.job_pref_hours or "Not set" }}</div>
              </div>
            </div>
            <div class="vcard-full-section">
              <div class="vcard-full-title">Skills</div>
              {% if skills %}
                {% for s in skills %}
                  <div class="vcard-item" style="margin-bottom:8px;">
                    <div class="vcard-item-title">{{ s.title }}</div>
                    {% if s.experience %}<div class="vcard-item-sub">{{ s.experience }}</div>{% endif %}
                    {% if s.description %}<div>{{ s.description }}</div>{% endif %}
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-muted small">No skills yet.</div>
              {% endif %}
            </div>
            <div class="vcard-full-section">
              <div class="vcard-full-title">Services</div>
              {% if services %}
                {% for s in services %}
                  <div class="vcard-item" style="margin-bottom:8px;">
                    <div class="vcard-item-title">{{ s.title }}</div>
                    {% if s.experience %}<div class="vcard-item-sub">{{ s.experience }}</div>{% endif %}
                    {% if s.description %}<div>{{ s.description }}</div>{% endif %}
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-muted small">No services yet.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="profile-card">
    <div class="section-head" style="background: var(--p-green-soft);">
      <div class="section-title">
        <i class="bi bi-file-earmark" style="background: var(--p-green);"></i>
        CV Library
      </div>
      <button class="btn btn-success section-add" type="button" onclick="showNewCvRow()">Add New CV</button>
    </div>
    <div class="section-body">
      <div id="newCvRow" class="profile-card" style="display:none; margin-bottom:12px; box-shadow:none;">
        <div class="section-body">
          <form class="row g-2" method="post" action="{{ url_for('profiles.cvfile_new') }}" enctype="multipart/form-data">
            <div class="col-md-8">
              <label class="form-label">CV Name</label>
              <input class="form-control" name="cv_name" placeholder="e.g., Scrum Master CV" required>
            </div>
            <div class="col-md-4 d-flex align-items-end gap-2">
              <button class="btn btn-success w-100" type="submit">Save</button>
              <button class="btn btn-outline-secondary w-100" type="button" onclick="hideNewCvRow()">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      {% for c in cv_files %}
        <div class="cv-row">
          <div>
            <div class="cv-title"><i class="bi bi-bookmark-fill text-primary"></i> {{ c.cv_name }}</div>
            <div class="cv-status">
              <span class="pill green"><i class="bi bi-check"></i> CV {{ 'Uploaded' if c.pdf_name else 'Missing' }}</span>
              {% if c.cover_pdf_name %}
                <span class="pill orange"><i class="bi bi-check"></i> Cover Uploaded</span>
              {% endif %}
            </div>
          </div>
          <div class="cv-actions">
            {% if c.pdf_name %}
              <a class="icon-btn" href="{{ url_for('profiles.cvfile_view', cvfile_id=c.cvfile_id) }}" title="View" aria-label="View"><i class="bi bi-eye"></i></a>
              <label class="icon-btn" for="cv_file_{{ c.cvfile_id }}" title="Replace CV" aria-label="Replace CV"><i class="bi bi-arrow-repeat"></i></label>
            {% else %}
              <label class="icon-btn" for="cv_file_{{ c.cvfile_id }}" title="Upload CV" aria-label="Upload CV"><i class="bi bi-upload"></i></label>
            {% endif %}

            <label class="icon-btn" for="cover_file_{{ c.cvfile_id }}" title="Upload Cover" aria-label="Upload Cover"><i class="bi bi-file-earmark-arrow-up"></i></label>
            <button class="icon-btn" type="button" onclick="togglePref('{{ c.cvfile_id }}')" title="Preferences" aria-label="Preferences"><i class="bi bi-sliders"></i></button>
            <form method="post" action="{{ url_for('profiles.cvfile_delete', cvfile_id=c.cvfile_id) }}" onsubmit="return confirm('Delete this CV?');">
              <button class="icon-btn danger" type="submit" title="Delete" aria-label="Delete"><i class="bi bi-trash"></i></button>
            </form>

            <form id="cv_upload_form_{{ c.cvfile_id }}" method="post" action="{{ url_for('profiles.cvfile_edit', cvfile_id=c.cvfile_id) }}" enctype="multipart/form-data">
              <input type="hidden" name="cv_name" value="{{ c.cv_name }}">
              <input class="d-none" type="file" name="pdf" id="cv_file_{{ c.cvfile_id }}" accept="application/pdf"
                     onchange="document.getElementById('cv_upload_form_{{ c.cvfile_id }}').submit();">
            </form>

            <form id="cover_upload_form_{{ c.cvfile_id }}" method="post" action="{{ url_for('profiles.cvfile_edit', cvfile_id=c.cvfile_id) }}" enctype="multipart/form-data">
              <input type="hidden" name="cv_name" value="{{ c.cv_name }}">
              <input class="d-none" type="file" name="cover_pdf" id="cover_file_{{ c.cvfile_id }}" accept="application/pdf"
                     onchange="document.getElementById('cover_upload_form_{{ c.cvfile_id }}').submit();">
            </form>
          </div>
        </div>

        <div id="pref_wrap_{{ c.cvfile_id }}" style="display:none; margin-bottom:8px;">
          <div class="profile-card" style="box-shadow:none; border-color:#e3eadb;">
            <div class="section-body">
              <form class="row g-2" method="post" action="{{ url_for('profiles.cvfile_edit', cvfile_id=c.cvfile_id) }}"
                    onsubmit="return buildPref('{{ c.cvfile_id }}')">
                <input type="hidden" name="job_pref" id="job_pref_hidden_{{ c.cvfile_id }}" value="{{ c.job_pref or '' }}">
                <div class="col-md-6">
                  <label class="form-label">CV Name</label>
                  <input class="form-control" name="cv_name" value="{{ c.cv_name }}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Preferred location</label>
                  <input class="form-control" id="pref_loc_{{ c.cvfile_id }}" name="job_pref_loc" placeholder="e.g., Remote"
                         value="{{ c.job_pref_loc or '' }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Work mode</label>
                  {% set pm = c.job_pref_mode or '' %}
                  <select class="form-select" id="pref_mode_{{ c.cvfile_id }}" name="job_pref_mode">
                    <option value="">Select</option>
                    <option value="wfo" {% if pm == 'wfo' %}selected{% endif %}>Work from office</option>
                    <option value="hybrid" {% if pm == 'hybrid' %}selected{% endif %}>Hybrid</option>
                    <option value="remote" {% if pm == 'remote' %}selected{% endif %}>Remote</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">City</label>
                  <input class="form-control" id="pref_city_{{ c.cvfile_id }}" name="job_pref_city" placeholder="e.g., Mumbai"
                         value="{{ c.job_pref_city or '' }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Hours per day</label>
                  <input class="form-control" type="number" min="1" max="24" id="pref_hours_{{ c.cvfile_id }}" name="job_pref_hours"
                         value="{{ c.job_pref_hours }}">
                </div>
                <div class="col-12 d-flex justify-content-end gap-2">
                  <button class="btn btn-success" type="submit">Save</button>
                  <button class="btn btn-outline-secondary" type="button" onclick="togglePref('{{ c.cvfile_id }}')">Cancel</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      {% else %}
        <div class="text-muted small">No CVs yet. Use "Add New CV" to create one.</div>
      {% endfor %}
    </div>
  </section>

  <section class="profile-card">
    <div class="section-head" style="background: var(--p-orange-soft);">
      <div class="section-title">
        <i class="bi bi-send" style="background: var(--p-orange);"></i>
        CV Send
      </div>
      <button class="btn btn-warning section-add" type="button" onclick="toggleSendForm(true)">New Share</button>
    </div>
    <div class="section-body">
      <div id="sendForm" style="display:none; margin-bottom:12px;">
        <form class="row g-2" method="post" action="{{ url_for('profiles.share_cvfile_new') }}">
          <div class="col-md-6">
            <label class="form-label">Select CV</label>
            <select class="form-select" name="cvfile_id" required>
              <option value="">Choose</option>
              {% for c in cv_files %}
                <option value="{{ c.cvfile_id }}">{{ c.cv_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Share option</label>
            <div class="d-flex gap-3 flex-wrap">
              <label class="d-flex align-items-center gap-1" style="margin:0;">
                <input type="radio" name="share_method" value="link" checked>
                <span class="small">Create link</span>
              </label>
              <label class="d-flex align-items-center gap-1" style="margin:0;">
                <input type="radio" name="share_method" value="handle">
                <span class="small">Handle</span>
              </label>
              <label class="d-flex align-items-center gap-1" style="margin:0;">
                <input type="radio" name="share_method" value="email">
                <span class="small">Email</span>
              </label>
            </div>
          </div>
          <div id="linkFields" class="col-md-6">
            <label class="form-label">Expiry (minutes)</label>
            <input class="form-control" type="number" name="expiry_minutes" min="0" max="1440" value="15">
          </div>
          <div id="linkFields2" class="col-md-6">
            <label class="form-label">Password (optional)</label>
            <input class="form-control" type="text" name="password" placeholder="Set password (optional)">
          </div>
          <div id="handleFields" class="col-md-6" style="display:none;">
            <label class="form-label">Handle</label>
            <input class="form-control" type="text" name="handle" placeholder="e.g., user123">
          </div>
          <div id="emailFields" class="col-md-6" style="display:none;">
            <label class="form-label">Email</label>
            <input class="form-control" type="email" name="email" placeholder="name@example.com">
          </div>
          <div class="col-12 d-flex justify-content-end gap-2">
            <button class="btn btn-warning" type="submit">Save share</button>
            <button class="btn btn-outline-secondary" type="button" onclick="toggleSendForm()">Cancel</button>
          </div>
        </form>
      </div>

      {% if my_shares or my_public_links %}
        {% for s in my_public_links %}
          <div class="send-row">
            <div>
              <i class="bi bi-link-45deg"></i>
              <a href="{{ url_for('profileviewer.view', token=s.token) }}" target="_blank">Link Share</a>
            </div>
            <div class="d-flex gap-2">
              <a class="icon-btn" href="{{ url_for('profileviewer.view', token=s.token) }}" target="_blank" aria-label="Open"><i class="bi bi-box-arrow-up-right"></i></a>
              <button class="icon-btn" type="button" onclick="toggleShareDetails('pl_{{ s.link_id }}')" aria-label="View details"><i class="bi bi-eye"></i></button>
              <form method="post" action="{{ url_for('profiles.delete_public_link', link_id=s.link_id) }}" onsubmit="return confirm('Delete this share?');">
                <button class="icon-btn danger" type="submit" aria-label="Delete"><i class="bi bi-trash"></i></button>
              </form>
            </div>
          </div>
          <div id="share_details_pl_{{ s.link_id }}" class="share-details" style="display:none;">
            <div><strong>Link:</strong> <a href="{{ url_for('profileviewer.view', token=s.token) }}" target="_blank">{{ url_for('profileviewer.view', token=s.token, _external=True) }}</a></div>
            <div><strong>Status:</strong> {{ s.status }}</div>
            <div><strong>Expires:</strong> {{ s.expires_at or "Never" }}</div>
            <div><strong>Download allowed:</strong> {{ "Yes" if s.allow_download else "No" }}</div>
            {% if s.name %}<div><strong>Label:</strong> {{ s.name }}</div>{% endif %}
          </div>
        {% endfor %}

        {% for s in my_shares %}
          <div class="send-row">
            <div>
              {% if s.target_user_id %}
                <i class="bi bi-person"></i> Handle Share
              {% else %}
                <i class="bi bi-envelope"></i> Email Share
              {% endif %}
            </div>
            <div class="d-flex gap-2">
              <a class="icon-btn" href="{{ url_for('profileviewer.view', token=s.share_token) }}" target="_blank" aria-label="Open"><i class="bi bi-box-arrow-up-right"></i></a>
              <button class="icon-btn" type="button" onclick="toggleShareDetails('s_{{ s.share_id }}')" aria-label="View details"><i class="bi bi-eye"></i></button>
              <form method="post" action="{{ url_for('profiles.delete_cvfile_share', cvfile_id=s.cvfile_id, share_id=s.share_id) }}" onsubmit="return confirm('Delete this share?');">
                <button class="icon-btn danger" type="submit" aria-label="Delete"><i class="bi bi-trash"></i></button>
              </form>
            </div>
          </div>
          <div id="share_details_s_{{ s.share_id }}" class="share-details" style="display:none;">
            {% set target_user = share_users.get(s.target_user_id) if s.target_user_id else None %}
            {% set target_profile = share_profiles.get(s.target_user_id) if s.target_user_id else None %}
            <div><strong>Share link:</strong> <a href="{{ url_for('profileviewer.view', token=s.share_token) }}" target="_blank">{{ url_for('profileviewer.view', token=s.share_token, _external=True) }}</a></div>
            {% if s.target_user_id %}
              <div><strong>Shared with:</strong> {{ target_profile.handle if target_profile and target_profile.handle else (target_user.email if target_user else ("User #" ~ s.target_user_id)) }}</div>
            {% else %}
              <div><strong>Shared with:</strong> {{ s.target_email or "Unknown" }}</div>
            {% endif %}
            <div><strong>Created:</strong> {{ s.created_at }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted small">No shares yet.</div>
      {% endif %}
    </div>
  </section>

  <section class="profile-card">
    <div class="section-head" style="background: var(--p-purple-soft);">
      <div class="section-title">
        <i class="bi bi-folder-check" style="background: var(--p-purple);"></i>
        CV Shared with Me
      </div>
    </div>
    <div class="section-body">
      {% if cvfile_shares %}
        {% for s in cvfile_shares %}
          {% set doc = shared_cvfiles.get(s.cvfile_id) if shared_cvfiles else None %}
          {% set owner = owners.get(s.owner_user_id) if owners else None %}
          <div class="shared-row">
            <div><i class="bi bi-file-earmark"></i> {{ doc.cv_name if doc else ("CV #" ~ s.cvfile_id) }}</div>
            <div class="shared-actions">
              <a class="btn btn-primary btn-sm" href="{{ url_for('profileviewer.view', token=s.share_token) }}" target="_blank"><i class="bi bi-eye"></i> View</a>
              <a class="btn btn-primary btn-sm" href="{{ url_for('chat.start_dm', user_id=s.owner_user_id) }}"><i class="bi bi-chat"></i> Chat</a>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted small">No CVs shared with you yet.</div>
      {% endif %}
    </div>
  </section>
</div>

<script>
  function showNewCvRow(){
    const row=document.getElementById('newCvRow');
    if(row) row.style.display='block';
  }
  function hideNewCvRow(){
    const row=document.getElementById('newCvRow');
    if(row) row.style.display='none';
  }
  function togglePref(id){
    const w=document.getElementById('pref_wrap_'+id);
    if(!w) return;
    w.style.display = w.style.display==='none' ? 'block' : 'none';
  }
  function buildPref(id){
    const parts=[];
    const loc=document.getElementById('pref_loc_'+id)?.value.trim();
    const mode=document.getElementById('pref_mode_'+id)?.value;
    const city=document.getElementById('pref_city_'+id)?.value.trim();
    const hrs=document.getElementById('pref_hours_'+id)?.value;
    if(loc) parts.push('Location: '+loc);
    if(mode){
      const label=mode==='wfo'?'Work from office':(mode==='hybrid'?'Hybrid':'Remote');
      parts.push('Mode: '+label);
    }
    if(city) parts.push('City: '+city);
    if(hrs) parts.push('Hours/day: '+hrs);
    const hidden=document.getElementById('job_pref_hidden_'+id);
    if(hidden) hidden.value=parts.join('; ');
    return true;
  }
  function toggleSendForm(forceShow){
    const el=document.getElementById('sendForm');
    if(!el) return;
    if(forceShow){ el.style.display='block'; return; }
    el.style.display = el.style.display==='none' ? 'block' : 'none';
  }
  function toggleVcardFull(btn){
    const el=document.getElementById('vcardFull');
    if(!el) return;
    const isHidden=getComputedStyle(el).display==='none';
    el.style.display = isHidden ? 'block' : 'none';
    const label = btn ? btn.querySelector('span') : null;
    if(label) label.textContent = isHidden ? 'Hide vCard' : 'View vCard';
  }
  function toggleShareDetails(id){
    const el=document.getElementById('share_details_'+id);
    if(!el) return;
    el.style.display = el.style.display==='none' ? 'block' : 'none';
  }
  (function setupShareSwitch(){
    const radios=document.querySelectorAll('input[name="share_method"]');
    const link=document.getElementById('linkFields');
    const link2=document.getElementById('linkFields2');
    const handle=document.getElementById('handleFields');
    const email=document.getElementById('emailFields');
    function update(){
      const val=[...radios].find(r=>r.checked)?.value;
      if(link) link.style.display = val==='link'?'block':'none';
      if(link2) link2.style.display = val==='link'?'block':'none';
      if(handle) handle.style.display = val==='handle'?'block':'none';
      if(email) email.style.display = val==='email'?'block':'none';
    }
    radios.forEach(r=>r.addEventListener('change', update));
    update();
  })();
</script>

{% endblock %}

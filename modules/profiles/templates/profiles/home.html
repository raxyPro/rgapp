{% extends "app_shell.html" %}
{% block content %}
<div class="hrow">
  <div>
    <h1>Profiles</h1>
    <p>Manage your vCard and CV files.</p>
  </div>
</div>

<!-- vCard section (unchanged) -->
<section class="card">
  <div class="cardHead">
    <div>
      <h2>My vCard</h2>
      <p>View mode by default. Collapse if you want more space.</p>
    </div>
    <div class="actions">
      <button class="btn" type="button" onclick="toggleVcard()">Collapse</button>
      <a class="btn primary" href="{{ url_for('profiles.edit_vcard') }}">Edit</a>
    </div>
  </div>
  <div class="cardBody" id="vcardBody">
    <div class="row">
      <div class="col-md-6">
        <div class="mb-3">
          <div class="text-muted">Name</div>
          <div class="fw-bold">{{ vcard.name or "Not set" }}</div>
        </div>
        <div class="mb-3">
          <div class="text-muted">Email</div>
          <div class="fw-bold">{{ vcard.email or "Not set" }}</div>
        </div>
        <div class="mb-3">
          <div class="text-muted">Phone</div>
          <div class="fw-bold">{{ vcard.phone or "Not set" }}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="mb-3">
          <div class="text-muted">LinkedIn</div>
          <div class="fw-bold">{{ vcard.linkedin_url or "Not set" }}</div>
        </div>
        <div class="mb-3">
          <div class="text-muted">Tagline</div>
          <div class="fw-bold">{{ vcard.tagline or "Not set" }}</div>
        </div>
        <div class="mb-3">
          <div class="text-muted">Location</div>
          <div class="fw-bold">{{ vcard.location or "Not set" }}</div>
        </div>
      </div>
    </div>
  </div>
</section>

<div style="height:14px;"></div>

<!-- CV files section -->
<section class="card">
  <div class="cardHead">
    <div>
      <h2>CV Files</h2>
      <p>Collapse or add a CV entry. Upload CV/cover later if needed.</p>
    </div>
    <div class="actions">
      <button class="btn" type="button" onclick="toggleCvFiles()">Collapse</button>
      <button class="btn primary" type="button" onclick="showNewCvRow()">Add CV</button>
    </div>
  </div>
  <div class="cardBody" id="cvFilesBody">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width:40px;">S.No</th>
            <th>CV Name</th>
            <th>Files</th>
            <th>Events</th>
          </tr>
        </thead>
        <tbody id="cvFilesBodyRows">
          <tr id="newCvRow" style="display:none;">
            <form method="post" action="{{ url_for('profiles.cvfile_new') }}" enctype="multipart/form-data">
              <td>New</td>
              <td colspan="2">
                <div class="d-flex flex-column gap-2">
                  <input class="form-control form-control-sm" name="cv_name" placeholder="e.g., Product Manager CV" required>
                  <div class="text-muted small">You can upload CV/cover after creating.</div>
                </div>
              </td>
              <td class="d-flex gap-2">
                <button class="btn btn-sm btn-primary" type="submit">Save</button>
                <button class="btn btn-sm btn-outline-secondary" type="button" onclick="hideNewCvRow()">Cancel</button>
              </td>
            </form>
          </tr>
          {% for c in cv_files %}
          <tr>
            <td>{{ loop.index }}</td>
            <td class="fw-semibold">{{ c.cv_name }}</td>
            <td>
              <div class="d-flex flex-column gap-2">
                <div class="d-flex align-items-center gap-2">
                  <strong>CV:</strong>
                  {% if c.pdf_name %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('profiles.cvfile_view', cvfile_id=c.cvfile_id) }}" target="_blank">View CV</a>
                    <form method="post" action="{{ url_for('profiles.cvfile_edit', cvfile_id=c.cvfile_id) }}" enctype="multipart/form-data" class="d-flex gap-2 mb-0">
                      <input type="hidden" name="cv_name" value="{{ c.cv_name }}">
                      <input class="form-control form-control-sm" type="file" name="pdf" accept="application/pdf" required>
                      <button class="btn btn-sm btn-outline-secondary" type="submit">Change CV</button>
                    </form>
                    <form method="post" action="{{ url_for('profiles.cvfile_delete', cvfile_id=c.cvfile_id) }}" onsubmit="return confirm('Delete this CV file?');">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Delete CV</button>
                    </form>
                  {% else %}
                    <span class="text-muted small">No CV uploaded</span>
                    <form class="d-flex gap-2" method="post" action="{{ url_for('profiles.cvfile_edit', cvfile_id=c.cvfile_id) }}" enctype="multipart/form-data">
                      <input type="hidden" name="cv_name" value="{{ c.cv_name }}">
                      <input class="form-control form-control-sm" type="file" name="pdf" accept="application/pdf" required>
                      <button class="btn btn-sm btn-primary" type="submit">Upload CV</button>
                    </form>
                  {% endif %}
                </div>
                <div class="d-flex align-items-center gap-2">
                  <strong>Cover:</strong>
                  {% if c.cover_pdf_name %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('profiles.cvfile_cover_view', cvfile_id=c.cvfile_id) }}" target="_blank">View Cover</a>
                    <form method="post" action="{{ url_for('profiles.cvfile_edit', cvfile_id=c.cvfile_id) }}" enctype="multipart/form-data" class="d-flex gap-2 mb-0">
                      <input type="hidden" name="cv_name" value="{{ c.cv_name }}">
                      <input class="form-control form-control-sm" type="file" name="cover_pdf" accept="application/pdf" required>
                      <button class="btn btn-sm btn-outline-secondary" type="submit">Change Cover</button>
                    </form>
                  {% else %}
                    <span class="text-muted small">No cover uploaded</span>
                    <form class="d-flex gap-2" method="post" action="{{ url_for('profiles.cvfile_edit', cvfile_id=c.cvfile_id) }}" enctype="multipart/form-data">
                      <input type="hidden" name="cv_name" value="{{ c.cv_name }}">
                      <input class="form-control form-control-sm" type="file" name="cover_pdf" accept="application/pdf" required>
                      <button class="btn btn-sm btn-primary" type="submit">Upload Cover</button>
                    </form>
                  {% endif %}
                </div>
              </div>
            </td>
            <td class="d-flex flex-column gap-2">
              <form class="d-flex gap-2" method="post" action="{{ url_for('profiles.cvfile_edit', cvfile_id=c.cvfile_id) }}">
                <input type="hidden" name="job_pref" value="{{ c.job_pref or '' }}">
                <input class="form-control form-control-sm" name="cv_name" value="{{ c.cv_name }}" required style="max-width:200px;">
                <button class="btn btn-sm btn-outline-secondary" type="submit">Edit</button>
              </form>
              <button class="btn btn-sm btn-outline-secondary" type="button" onclick="togglePref('{{ c.cvfile_id }}')">Preferences</button>
              <form method="post" action="{{ url_for('profiles.cvfile_delete', cvfile_id=c.cvfile_id) }}" onsubmit="return confirm('Delete this CV?');">
                <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
              </form>
              <div id="pref_wrap_{{ c.cvfile_id }}" class="mt-2" style="display:none; text-align:left;">
                <form method="post" action="{{ url_for('profiles.cvfile_edit', cvfile_id=c.cvfile_id) }}" onsubmit="return buildPref('{{ c.cvfile_id }}')">
                  <input type="hidden" name="cv_name" value="{{ c.cv_name }}">
                  <input type="hidden" name="job_pref" id="job_pref_hidden_{{ c.cvfile_id }}" value="{{ c.job_pref or '' }}">
                  <div class="mb-2">
                    <label class="form-label mb-1">Preferred location</label>
                    <input class="form-control form-control-sm" id="pref_loc_{{ c.cvfile_id }}" placeholder="e.g., Remote" value="{{ c.details.job_pref_loc if c.details and c.details.job_pref_loc else '' }}">
                  </div>
                  <div class="mb-2">
                    <label class="form-label mb-1">Work mode</label>
                    <select class="form-select form-select-sm" id="pref_mode_{{ c.cvfile_id }}">
                      <option value="">Select</option>
                      <option value="wfo">Work from office</option>
                      <option value="hybrid">Hybrid</option>
                      <option value="remote">Remote</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label mb-1">City</label>
                    <input class="form-control form-control-sm" id="pref_city_{{ c.cvfile_id }}" placeholder="e.g., Mumbai">
                  </div>
                  <div class="mb-2">
                    <label class="form-label mb-1">Available from</label>
                    <input class="form-control form-control-sm" type="date" id="pref_from_{{ c.cvfile_id }}">
                  </div>
                  <div class="mb-2">
                    <label class="form-label mb-1">Hours per day</label>
                    <input class="form-control form-control-sm" type="number" min="1" max="24" id="pref_hours_{{ c.cvfile_id }}">
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary" type="submit">Save preferences</button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="togglePref('{{ c.cvfile_id }}')">Cancel</button>
                  </div>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<div style="height:14px;"></div>

<!-- CV Send (share to network) -->
<section class="card">
  <div class="cardHead">
    <div>
      <h2>CV Send (share to network)</h2>
      <p>Create a link, share to a handle, or email.</p>
    </div>
    <div class="actions">
      <button class="btn" type="button" onclick="toggleSend()">Collapse</button>
      <button class="btn primary" type="button" onclick="toggleSendForm()">New share</button>
    </div>
  </div>
  <div class="cardBody" id="sendBody">
    <div id="sendForm" style="display:none;">
      <form method="post" action="{{ url_for('profiles.share_cvfile_new') }}" class="row gy-3">
        <div class="col-md-4">
          <label class="form-label">Select CV</label>
          <select class="form-select" name="cvfile_id" required>
            <option value="">Choose</option>
            {% for c in cv_files %}
            <option value="{{ c.cvfile_id }}">{{ c.cv_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Share option</label>
          <div class="d-flex gap-3">
            <label><input type="radio" name="share_method" value="link" checked> Create link</label>
            <label><input type="radio" name="share_method" value="handle"> Handle</label>
            <label><input type="radio" name="share_method" value="email"> Email</label>
          </div>
        </div>
        <div class="col-md-4" id="linkFields">
          <label class="form-label">Expiry (minutes)</label>
          <input class="form-control" type="number" name="expiry_minutes" min="0" max="1440" value="15">
          <label class="form-label mt-2">Password (optional)</label>
          <input class="form-control" type="text" name="password" placeholder="Set password (optional)">
        </div>
        <div class="col-md-4" id="handleFields" style="display:none;">
          <label class="form-label">Handle</label>
          <input class="form-control" type="text" name="handle" placeholder="e.g., user123">
          <div class="form-text">Must match an existing handle.</div>
        </div>
        <div class="col-md-4" id="emailFields" style="display:none;">
          <label class="form-label">Email</label>
          <input class="form-control" type="email" name="email" placeholder="name@example.com">
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit">Save share</button>
          <button class="btn btn-outline-secondary" type="button" onclick="toggleSendForm()">Cancel</button>
        </div>
      </form>
    </div>
    <div class="mt-3">
      <h6 class="mb-2">Existing shares</h6>
      {% if my_shares or my_public_links %}
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr><th>CV</th><th>Type</th><th>Target</th><th>Link</th></tr>
            </thead>
            <tbody>
              {% for s in my_public_links %}
              <tr>
                <td>{{ (cv_files|selectattr('cvfile_id','equalto', s.cvfile_id)|list|first).cv_name if cv_files else ('CV #' ~ s.cvfile_id) }}</td>
                <td>Link</td>
                <td>â€”</td>
                <td><a href="{{ url_for('profileviewer.view', token=s.token, _external=True) }}" target="_blank">View</a></td>
              </tr>
              {% endfor %}
              {% for s in my_shares %}
              <tr>
                <td>{{ (cv_files|selectattr('cvfile_id','equalto', s.cvfile_id)|list|first).cv_name if cv_files else ('CV #' ~ s.cvfile_id) }}</td>
                <td>{{ 'Handle' if s.target_user_id else 'Email' }}</td>
                <td>
                  {% if s.target_user_id %}
                    {% set u = share_users.get(s.target_user_id) %}
                    {% set p = share_profiles.get(s.target_user_id) %}
                    {{ p.handle or u.email if u else ('User #' ~ s.target_user_id) }}
                  {% else %}
                    {{ s.target_email }}
                  {% endif %}
                </td>
                <td><a href="{{ url_for('profileviewer.view', token=s.share_token, _external=True) }}" target="_blank">View</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-muted small">No shares yet.</div>
      {% endif %}
    </div>
  </div>
</section>

<div style="height:14px;"></div>

<!-- CV Shared with me -->
<section class="card">
  <div class="cardHead">
    <div>
      <h2>CV Shared with me</h2>
      <p>CVs shared to your account.</p>
    </div>
  </div>
  <div class="cardBody">
    {% if cvfile_shares %}
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr><th>CV Name</th><th>From</th><th>View</th><th>Chat</th></tr>
          </thead>
          <tbody>
            {% for s in cvfile_shares %}
              {% set doc = shared_cvfiles.get(s.cvfile_id) if shared_cvfiles else None %}
              {% set owner = owners.get(s.owner_user_id) if owners else None %}
              <tr>
                <td>{{ doc.cv_name if doc else ("CV #" ~ s.cvfile_id) }}</td>
                <td>{{ owner.handle or owner.email if owner else ("User #" ~ s.owner_user_id) }}</td>
                <td><a class="btn btn-sm btn-outline-primary" href="{{ url_for('profileviewer.view', token=s.share_token) }}" target="_blank">View</a></td>
                <td><a class="btn btn-sm btn-outline-secondary" href="{{ url_for('chat.start_dm', user_id=s.owner_user_id) }}">Chat</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted small">No CVs shared with you yet.</div>
    {% endif %}
  </div>
</section>

<script>
  function toggleVcard(){
    const el=document.getElementById('vcardBody');
    if(el) el.style.display=el.style.display==='none'?'block':'none';
  }
  function toggleCvFiles(){
    const el=document.getElementById('cvFilesBody');
    if(el) el.style.display=el.style.display==='none'?'block':'none';
  }
  function showNewCvRow(){
    const row=document.getElementById('newCvRow');
    if(row) row.style.display='table-row';
  }
  function hideNewCvRow(){
    const row=document.getElementById('newCvRow');
    if(row) row.style.display='none';
  }
  function togglePref(id){
    const w=document.getElementById('pref_wrap_'+id);
    if(!w) return;
    w.style.display = w.style.display==='none' ? 'block' : 'none';
  }
  function buildPref(id){
    const parts=[];
    const loc=document.getElementById('pref_loc_'+id)?.value.trim();
    const mode=document.getElementById('pref_mode_'+id)?.value;
    const city=document.getElementById('pref_city_'+id)?.value.trim();
    const from=document.getElementById('pref_from_'+id)?.value;
    const hrs=document.getElementById('pref_hours_'+id)?.value;
    if(loc) parts.push(`Location: ${loc}`);
    if(mode){
      const label=mode==='wfo'?'Work from office':(mode==='hybrid'?'Hybrid':'Remote');
      parts.push(`Mode: ${label}`);
    }
    if(city) parts.push(`City: ${city}`);
    if(from) parts.push(`Available from: ${from}`);
    if(hrs) parts.push(`Hours/day: ${hrs}`);
    const hidden=document.getElementById('job_pref_hidden_'+id);
    if(hidden) hidden.value=parts.join('; ');
    return true;
  }
  function toggleSend(){
    const el=document.getElementById('sendBody');
    if(el) el.style.display=el.style.display==='none'?'block':'none';
  }
  function toggleSendForm(){
    const el=document.getElementById('sendForm');
    if(el) el.style.display=el.style.display==='none'?'block':'none';
  }
  (function setupShareSwitch(){
    const radios=document.querySelectorAll('input[name=\"share_method\"]');
    const link=document.getElementById('linkFields');
    const handle=document.getElementById('handleFields');
    const email=document.getElementById('emailFields');
    function update(){
      const val=[...radios].find(r=>r.checked)?.value;
      if(link) link.style.display = val==='link'?'block':'none';
      if(handle) handle.style.display = val==='handle'?'block':'none';
      if(email) email.style.display = val==='email'?'block':'none';
    }
    radios.forEach(r=>r.addEventListener('change', update));
    update();
  })();
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h3 class="mb-0">CV Shared With Me</h3>
  <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('cv.home') }}">Back</a>
</div>

<div class="accordion" id="sharedAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingSActive">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSActive" aria-expanded="true" aria-controls="collapseSActive">
        Active
      </button>
    </h2>
    <div id="collapseSActive" class="accordion-collapse collapse show" aria-labelledby="headingSActive" data-bs-parent="#sharedAccordion">
      <div class="accordion-body">
        {% if not active %}
          <div class="text-muted">No shared CVs.</div>
        {% else %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Owner</th>
                  <th>CV</th>
                  <th style="width:320px;">Actions</th>
                </tr>
              </thead>
              <tbody>
              {% for s in active %}
                {% set p = pairs.get(s.cv_id) %}
                {% set o = owners.get(s.owner_user_id) %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ o.email if o else ("User #" ~ s.owner_user_id) }}</td>
                  <td>{{ (p.v_name if p else "CV") }}</td>
                  <td class="d-flex gap-2 flex-wrap">
                    <a class="btn btn-outline-success btn-sm" href="{{ url_for('cv.view_shared', share_id=s.share_id) }}">View</a>
                    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('cv.message_owner', share_id=s.share_id) }}">Message</a>
                    <form method="post" action="{{ url_for('cv.archive_share', share_id=s.share_id) }}">
                      <button class="btn btn-outline-secondary btn-sm" type="submit">Archive</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="accordion-item">
    <h2 class="accordion-header" id="headingSArchived">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSArchived" aria-expanded="false" aria-controls="collapseSArchived">
        Archived
      </button>
    </h2>
    <div id="collapseSArchived" class="accordion-collapse collapse" aria-labelledby="headingSArchived" data-bs-parent="#sharedAccordion">
      <div class="accordion-body">
        {% if not archived %}
          <div class="text-muted">No archived shared CVs.</div>
        {% else %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Owner</th>
                  <th>CV</th>
                  <th style="width:260px;">Actions</th>
                </tr>
              </thead>
              <tbody>
              {% for s in archived %}
                {% set p = pairs.get(s.cv_id) %}
                {% set o = owners.get(s.owner_user_id) %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ o.email if o else ("User #" ~ s.owner_user_id) }}</td>
                  <td>{{ (p.v_name if p else "CV") }}</td>
                  <td class="d-flex gap-2 flex-wrap">
                    <a class="btn btn-outline-success btn-sm" href="{{ url_for('cv.view_shared', share_id=s.share_id) }}">View</a>
                    <form method="post" action="{{ url_for('cv.unarchive_share', share_id=s.share_id) }}">
                      <button class="btn btn-outline-secondary btn-sm" type="submit">Unarchive</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

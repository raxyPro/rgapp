{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>CV Module</h2>

  <div class="accordion mt-3" id="cvAcc">

    <!-- My vCard (inline editable) -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="hV">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cV" aria-expanded="true">
          My vCard
        </button>
      </h2>
      <div id="cV" class="accordion-collapse collapse show" data-bs-parent="#cvAcc">
        <div class="accordion-body">
          <form method="post" action="{{ url_for('cv.save_vcard') }}">
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label">Name</label>
                <input class="form-control" name="name" value="{{ vcard.name }}">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label">Email</label>
                <input class="form-control" name="email" value="{{ vcard.email }}">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label">LinkedIn profile URL</label>
                <input class="form-control" name="linkedin_url" value="{{ vcard.linkedin_url }}">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label">Phone</label>
                <input class="form-control" name="phone" value="{{ vcard.phone }}">
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label">Tagline</label>
                <input class="form-control" name="tagline" value="{{ vcard.tagline }}">
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Skills</h6>
              <button class="btn btn-sm btn-outline-primary" type="button" onclick="addRow('skillsBody','skill')">Add Skill</button>
            </div>
            <div class="table-responsive mt-2">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th style="width:20%">Skill</th>
                    <th>Description</th>
                    <th style="width:25%">Experience (text)</th>
                    <th style="width:1%"></th>
                  </tr>
                </thead>
                <tbody id="skillsBody">
                  {% for s in skills %}
                  <tr>
                    <td><input class="form-control" name="skill_title[]" value="{{ s.title }}"></td>
                    <td><input class="form-control" name="skill_desc[]" value="{{ s.description }}"></td>
                    <td><input class="form-control" name="skill_exp[]" value="{{ s.experience }}"></td>
                    <td><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove()">X</button></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Services</h6>
              <button class="btn btn-sm btn-outline-primary" type="button" onclick="addRow('servicesBody','service')">Add Service</button>
            </div>
            <div class="table-responsive mt-2">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th style="width:20%">Service</th>
                    <th>Description</th>
                    <th style="width:25%">Experience (text)</th>
                    <th style="width:1%"></th>
                  </tr>
                </thead>
                <tbody id="servicesBody">
                  {% for s in services %}
                  <tr>
                    <td><input class="form-control" name="service_title[]" value="{{ s.title }}"></td>
                    <td><input class="form-control" name="service_desc[]" value="{{ s.description }}"></td>
                    <td><input class="form-control" name="service_exp[]" value="{{ s.experience }}"></td>
                    <td><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove()">X</button></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-primary" type="submit">Save vCard</button>
              <a class="btn btn-outline-secondary" href="{{ url_for('cv.share_vcard') }}">Share vCard</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- My CV (online + uploads) -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="hC">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cC" aria-expanded="true">
          My CV
        </button>
      </h2>
      <div id="cC" class="accordion-collapse collapse show" data-bs-parent="#cvAcc">
        <div class="accordion-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Online CVs</h5>
            <form method="post" action="{{ url_for('cv.pair_new') }}">
              <button class="btn btn-primary btn-sm" type="submit">Add Online CV</button>
            </form>
          </div>

          {% if active_pairs %}
          <div class="table-responsive mb-4">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Name</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for p in active_pairs %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ p.op_title or p.v_primary_skill or p.v_name or "Online CV" }}</td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('cv.pair_edit', cv_id=p.cv_id) }}">View/Edit</a>
                    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('cv.share_pair', cv_id=p.cv_id) }}">Share</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <div class="text-muted small mb-3">No online CVs yet. Click "Add Online CV" to start.</div>
          {% endif %}

          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Uploaded CVs</h5>
          </div>
          <form class="row g-2 align-items-end mb-3" method="post" action="{{ url_for('cv.cvfile_new') }}" enctype="multipart/form-data">
            <div class="col-md-4">
              <label class="form-label">CV Name</label>
              <input class="form-control" name="cv_name" placeholder="e.g., Software Engineer CV" required>
            </div>
            <div class="col-md-5">
              <label class="form-label">Upload PDF</label>
              <input class="form-control" type="file" name="pdf" accept="application/pdf" required>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary w-100" type="submit">Add CV</button>
            </div>
          </form>

          {% if cvfile_shares is not defined %}{% set cvfile_shares = [] %}{% endif %}
          {% if cv_files %}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>CV Name</th>
                    <th>File</th>
                    <th>Updated</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for c in cv_files %}
                  <tr>
                    <td>{{ c.cv_name }}</td>
                    <td class="text-muted">{{ c.original_filename }}</td>
                    <td class="text-muted">{{ c.updated_at.strftime("%Y-%m-%d %H:%M") if c.updated_at else "" }}</td>
                    <td class="text-end">
                      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('cv.share_cvfile', cvfile_id=c.cvfile_id) }}">Share</a>
                      <form method="post" action="{{ url_for('cv.cvfile_delete', cvfile_id=c.cvfile_id) }}" style="display:inline" onsubmit="return confirm('Delete this CV?');">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted small">No CV PDFs uploaded yet.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- vCard Shared -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="hVS">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cVS">
          vCard Shared With Me
        </button>
      </h2>
      <div id="cVS" class="accordion-collapse collapse" data-bs-parent="#cvAcc">
        <div class="accordion-body">
          {% if vcard_shares %}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Shared Date</th>
                    <th>Link</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in vcard_shares %}
                    {% set v = shared_vcards.get(s.vcard_id) %}
                    {% set o = owners.get(s.owner_user_id) %}
                    <tr>
                      <td>{{ (v.name if v else None) or (o.email if o else None) or ("User #" ~ s.owner_user_id) }}</td>
                      <td class="text-muted">{{ s.created_at.strftime("%Y-%m-%d %H:%M") if s.created_at else "" }}</td>
                      <td>
                        {% if s.is_public %}
                          <a href="{{ url_for('vcardviewer.view', token=s.share_token) }}" target="_blank">View</a>
                        {% else %}
                          <span class="text-muted">Private</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted">No vCards shared with you yet.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- CV Shared -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="hCS">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cCS">
          CV Shared With Me
        </button>
      </h2>
      <div id="cCS" class="accordion-collapse collapse" data-bs-parent="#cvAcc">
        <div class="accordion-body">
          {% if pair_shares %}
          <h6>One-Page CVs</h6>
          <div class="table-responsive mb-3">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>CV</th>
                  <th>Owner</th>
                  <th>Shared Date</th>
                  <th>Link</th>
                </tr>
              </thead>
              <tbody>
                {% for s in pair_shares %}
                  {% set p = shared_pairs.get(s.cv_id) %}
                  {% set o = owners.get(s.owner_user_id) %}
                  <tr>
                    <td>{{ p.op_title if p else ("CV #" ~ s.cv_id) }}</td>
                    <td>{{ o.email if o else ("User #" ~ s.owner_user_id) }}</td>
                    <td class="text-muted">{{ s.created_at.strftime("%Y-%m-%d %H:%M") if s.created_at else "" }}</td>
                    <td>
                      {% if s.is_public %}
                        <a href="{{ url_for('cvviewer.view_pair', token=s.share_token) }}" target="_blank">View</a>
                      {% else %}
                        <span class="text-muted">Private</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}

          {% if cvfile_shares %}
          <h6>Uploaded CV files</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>CV</th>
                  <th>Owner</th>
                  <th>Shared Date</th>
                  <th>Link</th>
                </tr>
              </thead>
              <tbody>
                {% for s in cvfile_shares %}
                  {% set c = shared_cvfiles.get(s.cvfile_id) %}
                  {% set o = owners.get(s.owner_user_id) %}
                  <tr>
                    <td>{{ c.cv_name if c else ("CV #" ~ s.cvfile_id) }}</td>
                    <td>{{ o.email if o else ("User #" ~ s.owner_user_id) }}</td>
                    <td class="text-muted">{{ s.created_at.strftime("%Y-%m-%d %H:%M") if s.created_at else "" }}</td>
                    <td>
                      {% if s.is_public %}
                        <a href="{{ url_for('cvviewer.view', token=s.share_token) }}" target="_blank">View</a>
                      {% else %}
                        <span class="text-muted">Private</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}

          {% if not pair_shares and not cvfile_shares %}
            <div class="text-muted">No CVs shared with you yet.</div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>

<script>
function addRow(tbodyId, kind){
  const tbody = document.getElementById(tbodyId);
  const tr = document.createElement('tr');
  if(kind === 'skill'){
    tr.innerHTML = `
      <td><input class="form-control" name="skill_title[]" value=""></td>
      <td><input class="form-control" name="skill_desc[]" value=""></td>
      <td><input class="form-control" name="skill_exp[]" value=""></td>
      <td><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove()">X</button></td>
    `;
  } else {
    tr.innerHTML = `
      <td><input class="form-control" name="service_title[]" value=""></td>
      <td><input class="form-control" name="service_desc[]" value=""></td>
      <td><input class="form-control" name="service_exp[]" value=""></td>
      <td><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove()">X</button></td>
    `;
  }
  tbody.appendChild(tr);
}
</script>
{% endblock %}

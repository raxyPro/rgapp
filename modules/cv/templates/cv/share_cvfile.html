{% extends "app_shell.html" %}
{% block content %}
<div class="hrow">
  <div>
    <h1>Share CV</h1>
    <p>Create public links or private shares with quick actions.</p>
  </div>
  <div class="row" style="flex:0 0 auto;">
    <a class="btn" href="{{ url_for('cv.home') }}">← Back</a>
  </div>
</div>

<!-- Document card -->
<section class="card">
  <div class="cardHead">
    <div>
      <h2>Document</h2>
      <p>Confirm you’re sharing the right file.</p>
    </div>
    <span class="pill">Owner: You</span>
  </div>
  <div class="cardBody" style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <div style="display:flex; gap:12px; min-width:260px;">
      <div class="logo" style="width:40px;height:40px;border-radius:12px;">CV</div>
      <div>
        <div style="font-weight:900; font-size:14px;">{{ c.cv_name }}</div>
        <div style="margin-top:6px; color:var(--muted); font-size:12.5px;">
          {{ c.original_filename }}
        </div>
      </div>
    </div>
  </div>
</section>

<div style="height:14px;"></div>

<!-- Unified sharing -->
<div>
  <section class="card">
    <div class="cardHead">
      <div>
        <h2>Add new share</h2>
        <p>Create a share via public link, Raygrow ID, or email. Optional expiry/password.</p>
      </div>
    </div>
    <div class="cardBody">
      <form class="row" method="post" action="{{ url_for('cv.create_public_link', cvfile_id=c.cvfile_id) }}">
        <div>
          <label>Share type</label>
          <select name="share_type" id="share_type" onchange="toggleTarget()">
            <option value="public">Public link</option>
            <option value="user">Raygrow ID</option>
            <option value="email">Email</option>
          </select>
        </div>
        <div id="target_wrap">
          <label id="target_label">Target (ID or email)</label>
          <input name="target" id="target" placeholder="User ID or email">
        </div>
        <div>
          <label>Name (optional)</label>
          <input name="name" placeholder="Recruiter A">
        </div>
        <div>
          <label>Expiry (minutes, 0 = no expiry)</label>
          <input name="expiry_minutes" type="number" min="0" max="1440" value="0" required>
        </div>
        <div>
          <label>Allow download</label>
          <select name="allow_download">
            <option value="false">No (view only)</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div>
          <label>Password (optional)</label>
          <input name="password" type="password" placeholder="Set password">
          <small>Hashed server-side</small>
        </div>
        <div style="flex:0 0 140px; display:flex; align-items:flex-end;">
          <button class="btn primary" type="submit">Add share</button>
        </div>
      </form>

      <div style="margin-top:12px;">
        <table class="table">
          <thead>
            <tr>
              <th style="width:6%;">S.No.</th>
              <th style="width:14%;">Type</th>
              <th style="width:24%;">Target</th>
              <th style="width:26%;">URL</th>
              <th style="width:18%;">Valid Till</th>
              <th style="width:12%;">Status</th>
              <th class="text-end" style="width:12%;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if public_links %}
              {% for pl in public_links %}
                {% set obj = pl.obj %}
                {% set status = pl.status %}
                {% set rem = pl.rem_secs %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ obj.share_type.title() }}</td>
                  <td>{{ obj.target or obj.name or '—' }}</td>
                  <td>{{ obj.target or obj.name or '—' }}</td>
                  <td class="mono">
                    <a href="{{ url_for('cvviewer.view', token=obj.token) }}" target="_blank">{{ url_for('cvviewer.view', token=obj.token, _external=True) }}</a>
                  </td>
                  <td>
                    {% if obj.expires_at %}
                      {% if rem is not none and rem <= 0 %}Expired{% else %}{{ obj.expires_at }}{% endif %}
                    {% else %}No expiry{% endif %}
                  </td>
                  <td>
                    {% if status == "expired" %}
                      <span class="pill bad">Expired</span>
                    {% elif status == "disabled" %}
                      <span class="pill bad">Disabled</span>
                    {% elif rem is not none and rem <= 300 %}
                      <span class="pill warn">Expiring</span>
                    {% else %}
                      <span class="pill ok">Active</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <div class="actions">
                      <a class="btn btn-sm" href="{{ url_for('cvviewer.view', token=obj.token) }}" target="_blank">View</a>
                      <form method="post" action="{{ url_for('cv.extend_public_link', link_id=obj.link_id) }}">
                        <button class="btn btn-sm warn" type="submit">+10m</button>
                      </form>
                      {% if status != "disabled" %}
                      <form method="post" action="{{ url_for('cv.disable_public_link', link_id=obj.link_id) }}">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Disable</button>
                      </form>
                      {% endif %}
                      <form method="post" action="{{ url_for('cv.delete_public_link', link_id=obj.link_id) }}" onsubmit="return confirm('Delete this share?');">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="6" style="color:var(--muted);">No shares yet.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<div style="height:14px;"></div>

<script>
  function copyLink(val){
    try{
      navigator.clipboard.writeText(val);
      alert('Link copied.');
    }catch(e){
      window.prompt('Copy link:', val);
    }
  }
  function toggleTarget(){
    const type = document.getElementById('share_type').value;
    const wrap = document.getElementById('target_wrap');
    const label = document.getElementById('target_label');
    if(type === 'public'){
      wrap.style.display = 'none';
    } else {
      wrap.style.display = 'block';
      label.innerText = type === 'user' ? 'Target Raygrow ID' : 'Target email';
    }
  }
  toggleTarget();
</script>
{% endblock %}

{% extends "app_shell.html" %}
{% block content %}
<div class="hrow">
  <div>
    <h1>Share CV</h1>
    <p>Create public links or private shares with quick actions.</p>
  </div>
  <div class="row" style="flex:0 0 auto;">
    <a class="btn" href="{{ url_for('cv.home') }}">← Back</a>
  </div>
</div>

<!-- Document card -->
<section class="card">
  <div class="cardHead">
    <div>
      <h2>Document</h2>
      <p>Confirm you’re sharing the right file.</p>
    </div>
    <span class="pill">Owner: You</span>
  </div>
  <div class="cardBody" style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <div style="display:flex; gap:12px; min-width:260px;">
      <div class="logo" style="width:40px;height:40px;border-radius:12px;">CV</div>
      <div>
        <div style="font-weight:900; font-size:14px;">{{ c.cv_name }}</div>
        <div style="margin-top:6px; color:var(--muted); font-size:12.5px;">
          {{ c.original_filename }}
        </div>
      </div>
    </div>
  </div>
</section>

<div style="height:14px;"></div>

<div class="grid">
  <!-- Public links -->
  <section class="card">
    <div class="cardHead">
      <div>
        <h2>Public links</h2>
        <p>Create multiple URLs with expiry, download rules, and optional password.</p>
      </div>
    </div>
    <div class="cardBody">
      <form class="row" method="post" action="{{ url_for('cv.create_public_link', cvfile_id=c.cvfile_id) }}">
        <div>
          <label>Name (optional)</label>
          <input name="name" placeholder="Recruiter A">
        </div>
        <div>
          <label>Expiry (minutes)</label>
          <input name="expiry_minutes" type="number" min="1" max="1440" value="15" required>
        </div>
        <div>
          <label>Allow download</label>
          <select name="allow_download">
            <option value="false">No (view only)</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div>
          <label>Password (optional)</label>
          <input name="password" type="password" placeholder="Set password">
          <small>Hashed server-side</small>
        </div>
        <div style="flex:0 0 140px; display:flex; align-items:flex-end;">
          <button class="btn primary" type="submit">Create link</button>
        </div>
      </form>

      <div style="margin-top:12px;">
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>URL</th>
              <th>Expiry</th>
              <th>Status</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if public_links %}
              {% for pl in public_links %}
                {% set obj = pl.obj %}
                {% set status = pl.status %}
                {% set rem = pl.rem_secs %}
                <tr>
                  <td>{{ obj.name or "(Untitled)" }}</td>
                  <td class="mono">
                    <div style="display:flex; align-items:center; gap:6px;">
                      <a href="{{ url_for('cvviewer.view', token=obj.token) }}" target="_blank">{{ obj.token[:8] }}...</a>
                      <button class="btn btn-sm" type="button" onclick="copyLink('{{ url_for('cvviewer.view', token=obj.token, _external=True) }}')">Copy</button>
                    </div>
                  </td>
                  <td>
                    {% if obj.expires_at %}
                      {% if rem is not none and rem <= 0 %}Expired{% else %}{{ obj.expires_at }}{% endif %}
                    {% else %}No expiry{% endif %}
                  </td>
                  <td>
                    {% if status == "expired" %}
                      <span class="pill bad">Expired</span>
                    {% elif status == "disabled" %}
                      <span class="pill bad">Disabled</span>
                    {% elif rem is not none and rem <= 300 %}
                      <span class="pill warn">Expiring</span>
                    {% else %}
                      <span class="pill ok">Active</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <div class="actions">
                      <form method="post" action="{{ url_for('cv.extend_public_link', link_id=obj.link_id) }}">
                        <button class="btn btn-sm warn" type="submit">+10m</button>
                      </form>
                      {% if status != "disabled" %}
                      <form method="post" action="{{ url_for('cv.disable_public_link', link_id=obj.link_id) }}">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Disable</button>
                      </form>
                      {% endif %}
                      <form method="post" action="{{ url_for('cv.delete_public_link', link_id=obj.link_id) }}" onsubmit="return confirm('Delete this link?');">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="5" style="color:var(--muted);">No public links yet.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Private sharing -->
  <section class="card">
    <div class="cardHead">
      <div>
        <h2>Private sharing</h2>
        <p>Controlled access for internal users or specific emails.</p>
      </div>
    </div>
    <div class="cardBody">
      <div style="display:grid; gap:12px;">
        <div>
          <label>Share with rgPro user</label>
          <form method="post" action="{{ url_for('cv.share_cvfile_user', cvfile_id=c.cvfile_id) }}">
            <select name="target_user_id" required>
              <option value="">Select a user</option>
              {% for u in users %}
                <option value="{{ u.user_id }}">{{ u.email }}</option>
              {% endfor %}
            </select>
            <div style="height:10px;"></div>
            <button class="btn primary" type="submit" style="width:100%;">Share privately</button>
          </form>
        </div>
        <div style="border-top:1px solid var(--border); padding-top:10px;">
          <label>Share via email</label>
          <form method="post" action="{{ url_for('cv.share_cvfile_email', cvfile_id=c.cvfile_id) }}">
            <input name="target_email" placeholder="name@example.com" required>
            <div style="height:10px;"></div>
            <button class="btn" type="submit" style="width:100%;">Create email share</button>
            <div style="margin-top:6px; color:var(--muted); font-size:12.5px;">Creates a private share entry (email sending optional).</div>
          </form>
        </div>
      </div>
    </div>
  </section>
</div>

<div style="height:14px;"></div>

<!-- Existing shares -->
<section class="card">
  <div class="cardHead">
    <div>
      <h2>Existing shares</h2>
      <p>Public and private shares for this CV.</p>
    </div>
  </div>
  <div class="cardBody">
    {% if shares %}
      <table class="table">
        <thead>
          <tr>
            <th style="width:14%;">Type</th>
            <th style="width:22%;">Target</th>
            <th style="width:24%;">Link</th>
            <th style="width:18%;">Created</th>
            <th style="width:12%; text-align:right;">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for s in shares %}
          <tr>
            <td>{{ "Public" if s.is_public else "Private" }}</td>
            <td>
              {% if s.target_user_id %}User #{{ s.target_user_id }}{% elif s.target_email %}{{ s.target_email }}{% else %}-{% endif %}
            </td>
            <td class="mono">
              {% if s.is_public %}
                <a href="{{ url_for('cvviewer.view', token=s.share_token) }}" target="_blank">Open</a>
              {% else %}
                <span style="color:var(--muted);">Private</span>
              {% endif %}
            </td>
            <td style="color:var(--muted);">{{ s.created_at.strftime("%Y-%m-%d %H:%M") if s.created_at else "" }}</td>
            <td style="text-align:right;">
              <form method="post" action="{{ url_for('cv.delete_cvfile_share', cvfile_id=c.cvfile_id, share_id=s.share_id) }}" onsubmit="return confirm('Delete this share?');">
                <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div style="color:var(--muted);">No shares yet.</div>
    {% endif %}
  </div>
</section>

<script>
  function copyLink(val){
    try{
      navigator.clipboard.writeText(val);
      alert('Link copied.');
    }catch(e){
      window.prompt('Copy link:', val);
    }
  }
</script>
{% endblock %}

{# modules/chat/templates/chat/new_chat.html #}
{% extends "app_shell.html" %}
{% set suppress_flash = true %}
{% block content %}
{% include "chat/_chat_styles.html" %}

<div class="rg-chat-topbar">
  <div class="rg-chat-topbar-left">
    <button class="rg-icon-btn" type="button" aria-label="Menu"><i class="bi bi-list"></i></button>
    <div class="rg-chat-topbar-title">Chats</div>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <span class="rg-chat-flash">{{ msg }}</span>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>
  <div class="rg-chat-topbar-right">
    <a class="rg-icon-btn" href="{{ url_for('chat.index') }}" aria-label="Back"><i class="bi bi-arrow-left"></i></a>
  </div>
</div>

<div class="rg-chat-layout" style="grid-template-columns:1fr;">
  <section class="rg-chat-panel" style="max-width:720px;margin:0 auto;width:100%;">
    <div class="rg-chat-panel-head">
      <div>
        <div class="rg-chat-panel-title">New chat</div>
        <div class="rg-chat-panel-sub">Start a direct, group, or broadcast chat.</div>
      </div>
    </div>
    <div class="rg-chat-panel-body" style="background:#fff;">
      <form method="post" action="{{ url_for('chat.create_chat') }}">
        <div class="mb-3">
          <label class="form-label">Chat type</label>
          <div class="d-flex gap-3 flex-wrap">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="chat_type" id="type_dm" value="dm" checked>
              <label class="form-check-label" for="type_dm">O2O (one-to-one)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="chat_type" id="type_group" value="group">
              <label class="form-check-label" for="type_group">GC (group chat)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="chat_type" id="type_broadcast" value="broadcast">
              <label class="form-check-label" for="type_broadcast">BC (broadcast)</label>
            </div>
          </div>
        </div>

        <div class="mb-3 js-name-row" style="display:none;">
          <label class="form-label" id="nameLabel">Name</label>
          <input class="form-control" name="group_name" id="group_name" placeholder="e.g., Finance">
          <div class="form-text" id="nameHelp">Provide a name.</div>
        </div>

        <div class="mb-3 js-users-row">
          <label class="form-label">Choose users</label>
          <div style="border:1px solid var(--chat-border);border-radius:10px;padding:10px;max-height:320px;overflow:auto;background:#fff;">
            {% for u in users %}
              <div class="form-check">
                <input class="form-check-input user-choice" type="checkbox" name="user_ids" value="{{ u.user_id }}" id="u{{u.user_id}}">
                <label class="form-check-label" for="u{{u.user_id}}">
                  {{ u.display_label or ("User " ~ u.user_id) }}
                </label>
              </div>
            {% endfor %}
          </div>
          <div class="form-text js-users-help">Select exactly 1 user for O2O, or 2+ for GC.</div>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-primary profile-btn" type="submit">Start chat</button>
          <a class="btn btn-outline-secondary profile-btn" href="{{ url_for('chat.index') }}">Cancel</a>
        </div>
      </form>
    </div>
  </section>
</div>

<script>
  (function() {
    const typeRadios = document.querySelectorAll('input[name="chat_type"]');
    const nameRow = document.querySelector('.js-name-row');
    const nameInput = document.getElementById('group_name');
    const nameLabel = document.getElementById('nameLabel');
    const nameHelp = document.getElementById('nameHelp');
    const usersRow = document.querySelector('.js-users-row');
    const usersHelp = document.querySelector('.js-users-help');
    const userChecks = Array.from(document.querySelectorAll('.user-choice'));

    function applyType(type) {
      const isBroadcast = type === 'broadcast';
      const isGroup = type === 'group';
      const isDm = type === 'dm';

      if (nameRow) {
        nameRow.style.display = (isBroadcast || isGroup) ? 'block' : 'none';
        nameInput.required = isBroadcast || isGroup;
        nameInput.placeholder = isBroadcast ? 'e.g., Product Updates' : 'e.g., Finance';
        nameLabel.textContent = isBroadcast ? 'Broadcast name' : 'Group name';
        nameHelp.textContent = isBroadcast
          ? 'Required; unique for you (subscribers will see name by creator).'
          : 'Required; unique for you; add at least two people to start.';
      }

      if (usersRow) {
        usersRow.style.display = isBroadcast ? 'none' : 'block';
        usersHelp.textContent = isBroadcast
          ? 'Broadcast does not require selecting users.'
          : (isGroup ? 'Select 2 or more users.' : 'Select exactly 1 user.');
      }

      const singleMode = isDm;
      userChecks.forEach((cb) => {
        cb.onclick = () => {
          if (singleMode && cb.checked) {
            userChecks.filter(x => x !== cb).forEach(x => x.checked = false);
          }
        };
      });
    }

    typeRadios.forEach(r => {
      r.addEventListener('change', () => applyType(r.value));
      if (r.checked) applyType(r.value);
    });
    const checked = Array.from(typeRadios).find(r => r.checked);
    applyType(checked ? checked.value : 'dm');
  })();
</script>
{% endblock %}

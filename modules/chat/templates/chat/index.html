{# modules/chat/templates/chat/index.html #}
{% extends "app_shell.html" %}
{% set suppress_flash = true %}
{% block content %}
{% include "chat/_chat_styles.html" %}

<div class="rg-chat-topbar">
  <div class="rg-chat-topbar-left">
    <button class="rg-icon-btn" type="button" aria-label="Menu"><i class="bi bi-list"></i></button>
    <div class="rg-chat-topbar-title">RayGrow Bridge</div>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <span class="rg-chat-flash">{{ msg }}</span>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>
  <div class="rg-chat-topbar-right">
    <a class="rg-icon-btn" href="{{ url_for('user.profile') }}" aria-label="Profile"><i class="bi bi-person-circle"></i></a>
    <button class="rg-icon-btn" type="button" aria-label="Status"><i class="bi bi-circle-fill"></i></button>
  </div>
</div>

<div class="rg-chat-layout">
  <aside class="rg-chat-sidebar">
    <div class="rg-chat-sidebar-title">Chats</div>

    <div class="rg-chat-search">
      <i class="bi bi-search"></i>
      <input id="rgChatSearch" placeholder="Search" oninput="rgFilterChats(this.value)">
      <a class="rg-chat-plus" href="{{ url_for('chat.new_chat') }}" aria-label="New chat"><i class="bi bi-plus-lg"></i></a>
    </div>

    <button class="btn btn-primary rg-chat-new" type="button" onclick="window.location='{{ url_for('chat.new_chat') }}'">New Chat</button>

    <div class="rg-chat-list" id="rgChatList">
      {% set ns = namespace(has_chats=false) %}
      {% for t in threads if t.thread_type != "broadcast" %}
        {% set ns.has_chats = true %}
        {% set members = members_by_thread.get(t.thread_id, []) %}
        {% set title = t.display_name_for(me_id, members, users_by_id) %}
        {% set total = message_counts.get(t.thread_id, 0) if message_counts else 0 %}
        {% set unread = unread_counts.get(t.thread_id, 0) if unread_counts else 0 %}

        <a class="rg-chat-item {% if active_thread and active_thread.thread_id == t.thread_id %}active{% endif %}"
           data-title="{{ title|lower }}"
           href="{{ url_for('chat.thread', thread_id=t.thread_id) }}">
          <div class="rg-chat-avatar"><i class="bi bi-person"></i></div>
          <div class="rg-chat-info">
            <div class="rg-chat-name">{{ title }}</div>
            <div class="rg-chat-sub">{{ "Group Chat" if t.thread_type == "group" else "Direct" }}</div>
          </div>
          {% if unread %}
            <div class="rg-chat-badge">{{ unread }}</div>
          {% else %}
            <div class="rg-chat-badge muted">{{ total }}</div>
          {% endif %}
        </a>
      {% endfor %}
      {% if not ns.has_chats %}
        <div class="text-muted small">No chats yet. Click New Chat.</div>
      {% endif %}

      <div class="rg-chat-section-title">Broadcasts</div>

      <div class="rg-chat-subsection">Owned</div>
      {% if owned_broadcasts %}
        {% for b in owned_broadcasts %}
          {% set title = b.display_name_for(me_id, members_by_thread.get(b.thread_id, []) or [], users_by_id) %}
          {% set total = broadcast_counts.get(b.thread_id, 0) if broadcast_counts else 0 %}
          <a class="rg-chat-item {% if active_thread and active_thread.thread_id == b.thread_id %}active{% endif %}"
             data-title="{{ title|lower }}"
             href="{{ url_for('chat.thread', thread_id=b.thread_id) }}">
            <div class="rg-chat-avatar"><i class="bi bi-megaphone"></i></div>
            <div class="rg-chat-info">
              <div class="rg-chat-name">{{ title }}</div>
              <div class="rg-chat-sub">Broadcast</div>
            </div>
            <div class="rg-chat-badge muted">{{ total }}</div>
          </a>
        {% endfor %}
      {% else %}
        <div class="text-muted small">No broadcasts created.</div>
      {% endif %}

      <div class="rg-chat-subsection">Subscribed</div>
      {% if subscribed_broadcasts %}
        {% for b in subscribed_broadcasts %}
          {% set title = b.display_name_for(me_id, members_by_thread.get(b.thread_id, []) or [], users_by_id) %}
          {% set total = broadcast_counts.get(b.thread_id, 0) if broadcast_counts else 0 %}
          <div class="rg-chat-item {% if active_thread and active_thread.thread_id == b.thread_id %}active{% endif %}"
               data-title="{{ title|lower }}">
            <a href="{{ url_for('chat.thread', thread_id=b.thread_id) }}" style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:10px;flex:1;">
              <div class="rg-chat-avatar"><i class="bi bi-rss"></i></div>
              <div class="rg-chat-info">
                <div class="rg-chat-name">{{ title }}</div>
                <div class="rg-chat-sub">Broadcast</div>
              </div>
              <div class="rg-chat-badge muted">{{ total }}</div>
            </a>
            <form method="post" action="{{ url_for('chat.unsubscribe_broadcast', thread_id=b.thread_id) }}" style="margin-left:auto;">
              <button class="btn btn-sm btn-outline-danger profile-btn" type="submit">Unsubscribe</button>
            </form>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted small">No subscriptions yet.</div>
      {% endif %}

      <div class="rg-chat-subsection d-flex align-items-center justify-content-between">
        <span>Available</span>
        <button class="btn btn-sm btn-outline-secondary profile-btn" type="button" onclick="toggleAvailableBroadcasts()">+</button>
      </div>
      <div id="availableBroadcasts" style="display:none;">
        {% if available_broadcasts %}
          {% for b in available_broadcasts %}
            {% set title = b.display_name_for(me_id, members_by_thread.get(b.thread_id, []) or [], users_by_id) %}
            <div class="rg-chat-item" data-title="{{ title|lower }}">
              <div class="rg-chat-avatar"><i class="bi bi-broadcast"></i></div>
              <div class="rg-chat-info">
                <div class="rg-chat-name">{{ title }}</div>
                <div class="rg-chat-sub">Subscribe to view</div>
              </div>
              <form method="post" action="{{ url_for('chat.subscribe_broadcast', thread_id=b.thread_id) }}">
                <button class="btn btn-sm btn-outline-primary profile-btn" type="submit">Join</button>
              </form>
            </div>
          {% endfor %}
        {% else %}
          <div class="text-muted small">No available broadcasts.</div>
        {% endif %}
      </div>
    </div>
  </aside>

  <main class="rg-chat-panel">
    {% block chat_main %}
      <div class="rg-chat-panel-head">
        <div>
          <div class="rg-chat-panel-title">No chat selected</div>
          <div class="rg-chat-panel-sub">Please select a chat from the list.</div>
        </div>
      </div>
      <div class="rg-chat-panel-body">
        <div class="rg-chat-empty">
          <div>
            <div style="font-weight:700;font-size:18px;">No chat selected</div>
            <div class="text-muted">Pick a chat or create a new one.</div>
          </div>
        </div>
      </div>
      <div class="rg-compose" style="opacity:.6;">
        <textarea class="form-control" rows="2" disabled placeholder="Select a chat to start messaging"></textarea>
        <button class="btn btn-primary" disabled><i class="bi bi-send"></i></button>
      </div>
    {% endblock %}
  </main>
</div>

<script>
  function rgFilterChats(q){
    q = (q || "").toLowerCase().trim();
    const list = document.getElementById("rgChatList");
    if(!list) return;
    list.querySelectorAll(".rg-chat-item").forEach(a=>{
      const title = a.getAttribute("data-title") || "";
      a.style.display = (!q || title.includes(q)) ? "" : "none";
    });
  }
  function toggleAvailableBroadcasts() {
    const box = document.getElementById('availableBroadcasts');
    if (!box) return;
    const visible = box.style.display === 'block';
    box.style.display = visible ? 'none' : 'block';
  }
</script>
{% endblock %}

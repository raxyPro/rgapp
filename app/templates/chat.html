<div class="flex flex-col md:flex-row h-screen">
  <!-- Left panel: Chat topic list -->
  <div class="w-full md:w-1/3 overflow-y-auto bg-gray-100 p-4">
    {% for topic in topics %}
      <div class="chat-card bg-white rounded shadow mb-2 p-4 cursor-pointer" onclick="activateChat({{ topic.id }})">
        <h3 class="font-bold text-lg">{{ topic.name }}</h3>
        <p class="text-sm text-gray-500">{{ topic.messages[-1].message if topic.messages else "No messages yet" }}</p>
      </div>
    {% endfor %}
  </div>

  <!-- Right panel: Chat messages -->
  <div class="w-full md:w-2/3 flex flex-col p-4">
    <div id="chat-box" class="flex-1 overflow-y-auto bg-white rounded shadow p-4">
      <!-- Messages will be loaded dynamically here -->
    </div>

    <form id="chat-form" class="mt-2 flex" onsubmit="sendMessage(); return false;">
      <input type="hidden" id="active-topic-id" name="topic_id">
      <input type="text" id="chat-input" class="flex-1 border p-2 rounded-l" placeholder="Type a message">
      <button type="submit" class="bg-blue-500 text-white px-4 rounded-r">Send</button>
    </form>
  </div>
</div>

<script>
  const allTopics = {{ topics|tojson }};

  function activateChat(topicId) {
    const topic = allTopics.find(t => t.id === topicId);
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("active-topic-id");

    input.value = topicId;

    chatBox.innerHTML = topic.messages.map(msg => `
      <div class="mb-2">
        <span class="font-bold">${msg.sender}</span>: ${msg.message}
        <div class="text-xs text-gray-500">${msg.sent_at}</div>
      </div>
    `).join('');
  }

  function sendMessage() {
    const topicId = document.getElementById("active-topic-id").value;
    const input = document.getElementById("chat-input");
    const message = input.value.trim();
    if (!message) return;

    // Simple POST using fetch (update endpoint as needed)
    fetch('/send_message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ topic_id: topicId, message: message })
    }).then(resp => resp.json()).then(data => {
      if (data.success) {
        // Refresh chat UI (in production, use websockets or partial reload)
        location.reload();
      }
    });

    input.value = '';
  }
</script>
